<!DOCTYPE HTML>
<html>
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
  </head>
    
    <style>
        
    </style>
    
  <body>  
      <div class="cart">
          
      </div>
      
      
      <div class="item" data-id="20">
          <div class="item-name">Sprej na zastavovani rozjetych kolotocu</div>
          <div class="item-price">5$</div>
          <div class="item-count">2</div>
          
          <button class="buy">Koupit</button>
      </div>
      
      <div class="item" data-id="22">
          <div class="item-name">Sprej na likvidaci facebookovych statusu</div>
          <div class="item-price">10$</div>
          <div class="item-count">1</div>
          
          <button class="buy">Koupit</button>
      </div>
      
      <div class="item" data-id="23">
          <div class="item-name">Sprej na odstraneni pilin z hlavy nacistickych kryptofasistu</div>
          <div class="item-price">10$</div>
          <div class="item-count">1</div>
          
          <button class="buy">Koupit</button>
      </div>
      
      <button id="send">send</button>
      <button id="get">get</button>
      <script>
          
          //closest polyfill, kterej potrebuji na detekovani rodice buy buttonu
          if (window.Element && !Element.prototype.closest) {
              Element.prototype.closest = 
              function(s) {
                  var matches = (this.document || this.ownerDocument).querySelectorAll(s),
                      i,
                      el = this;
                  do {
                      i = matches.length;
                      while (--i >= 0 && matches.item(i) !== el) {};
                  } while ((i < 0) && (el = el.parentElement)); 
                  return el;
              };
            }
          
          //projede array a podiva se jestli v nem existuje urcity vyraz
          Array.prototype.searchFor = function(candid) {
            for (var i=0; i<this.length; i++)
                if (this[i].indexOf(candid) == 0)
                    return i;
            return -1;
        };
          
          // udelas z objektu string
          Object.prototype.cartObjString = function(id, name, price, count ){
              return id + name + price + count;
          }
          
          
          var buy = document.querySelectorAll('.buy');
          
          
          var cartContent = JSON.parse(sessionStorage.getItem('cart'));
          var cartStrings = JSON.parse(sessionStorage.getItem('cartStrings'));
          
          if(cartContent == null){
              cartContent = [];
              cartStrings = [];
          }
          
          
          
          
          
          buy.forEach(function(el, index, array){
              el.addEventListener('click', function(){
                  console.log('add')
                  var parent = this.closest('.item');
                  var name = parent.querySelector('.item-name');
                  var price = parent.querySelector('.item-price');
                  var count = parent.querySelector('.item-count');
                  var idText = parent.getAttribute('data-id');
                  var idNum = parseFloat(parent.getAttribute('data-id'));
                  
                  var item = {
                    
                    id: idNum,
                    name: name.innerHTML,
                    price: price.innerHTML,
                    count: count.innerHTML,
                    
                  };
                  
                  var uglied = item.cartObjString(item.id, item.name, item.price, item.count);
                  
                  if(cartStrings.searchFor(idText) != -1){
                      console.log('nepridam');
                  } else {
                      
                      cartContent.push(item);
                      cartStrings.push(uglied);
                      
                      sessionStorage.setItem('cart', JSON.stringify(cartContent));
                      sessionStorage.setItem('cartStrings', JSON.stringify(cartStrings));
                      
                      var newElement = document.createElement('div');
                      var btn = document.createElement('button');
                        btn.classList.add('delete');
                        btn.innerHTML = 'Vymazat';
                      newElement.classList.add('item');
                       newElement.setAttribute('data-id', cartContent[cartContent.length - 1].id);
                    
                        newElement.innerHTML = '<div class="item-name">' + cartContent[cartContent.length - 1].name + '</div>' + 
                        '<div class="item-price">' + cartContent[cartContent.length - 1].price + '</div>' + 
                        '<div class="item-count">' + cartContent[cartContent.length - 1].count + '</div>';
                      
                      newElement.appendChild(btn);
                      
                        document.querySelector('.cart').appendChild(newElement);
                      
                  }
                   
              });
                
          });
          
          function addItemToCart(){
              
              
                for (var i=0; i < cartContent.length; i++) {
                    var newElement = document.createElement('div');
                    var btn = document.createElement('button');
                    btn.classList.add('delete');
                    btn.innerHTML = 'Vymazat';
                    newElement.classList.add('item');
                    newElement.setAttribute('data-id', cartContent[i].id);
                    
                    newElement.innerHTML = '<div class="item-name">' + cartContent[i].name + '</div>' + 
                                            '<div class="item-price">' + cartContent[i].price + '</div>' + 
                                            '<div class="item-count">' + cartContent[i].count + '</div>';
                    newElement.appendChild(btn);
                    
                    document.querySelector('.cart').appendChild(newElement);
                    
                    
                } 
              
              
          }
          
          addItemToCart();
          
          
          
          
          
          
              document.addEventListener('click', function(e){
                  if(e.target.classList.contains('delete')){
                      var item = e.target.parentElement;
                      var itemIdStr = item.getAttribute('data-id');
                      var itemID = parseFloat(itemIdStr);

                      var cart = item.parentElement;
                      cart.removeChild(item);

                      function getByValue(arr, value) {

                          for (var i=0, iLen=arr.length; i<iLen; i++) {

                            if (arr[i].id == value) return i;
                          }
                        }


  
                      cartContent.splice(getByValue(cartContent, itemID), 1);
                      cartStrings.splice(cartStrings.searchFor(itemIdStr), 1);

                      sessionStorage.setItem('cart', JSON.stringify(cartContent));
                      sessionStorage.setItem('cartStrings', JSON.stringify(cartStrings));
                  }
                  
                  

              });
          
          
          
          

          
          
          
          
          
            
      </script>
  </body>
    
</html>  